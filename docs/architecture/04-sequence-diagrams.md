# Sequence Diagrams

## 1. User Filtering & Prediction Flow

```
┌──────┐        ┌─────────┐        ┌──────────┐        ┌───────┐        ┌──────────┐        ┌─────────┐        ┌─────────┐
│ User │        │ Next.js │        │   API    │        │ Redis │        │   Odds   │        │  Stats  │        │Prediction│
│      │        │  Client │        │  Routes  │        │ Cache │        │ Service  │        │ Service │        │  Engine  │
└──┬───┘        └────┬────┘        └────┬─────┘        └───┬───┘        └────┬─────┘        └────┬────┘        └────┬────┘
   │                 │                   │                  │                  │                   │                  │
   │ 1. Set filters  │                   │                  │                  │                   │                  │
   │ (odds: 1.2-1.8) │                   │                  │                  │                   │                  │
   │ (markets: H2H)  │                   │                  │                  │                   │                  │
   │ (date: today)   │                   │                  │                  │                   │                  │
   ├────────────────>│                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │ 2. POST /api/     │                  │                  │                   │                  │
   │                 │    matches/search │                  │                  │                   │                  │
   │                 ├──────────────────>│                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │ 3. Validate input│                  │                   │                  │
   │                 │                   │    (Zod schema)  │                  │                   │                  │
   │                 │                   ├─────────┐        │                  │                   │                  │
   │                 │                   │         │        │                  │                   │                  │
   │                 │                   │<────────┘        │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │ 4. Check cache   │                  │                   │                  │
   │                 │                   │    Key: odds:EPL:│                  │                   │                  │
   │                 │                   │    2025-11-30    │                  │                   │                  │
   │                 │                   ├─────────────────>│                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │ 5. Cache MISS    │                   │                  │
   │                 │                   │<─────────────────┤                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │ 6. Fetch odds    │                  │                   │                  │
   │                 │                   ├─────────────────────────────────────>│                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │ 7. Call The Odds API                 │
   │                 │                   │                  │                  ├───────────┐       │                  │
   │                 │                   │                  │                  │ (External)│       │                  │
   │                 │                   │                  │                  │<──────────┘       │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │ 8. Normalize &    │                  │
   │                 │                   │                  │                  │    Filter odds    │                  │
   │                 │                   │                  │                  ├───────────┐       │                  │
   │                 │                   │                  │                  │           │       │                  │
   │                 │                   │                  │                  │<──────────┘       │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │ 9. Return odds   │                   │                  │
   │                 │                   │<─────────────────────────────────────┤                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │ 10. Store in cache                  │                   │                  │
   │                 │                   │    (TTL: 5 min)  │                  │                   │                  │
   │                 │                   ├─────────────────>│                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │ 11. For each match,                 │                   │                  │
   │                 │                   │     fetch stats  │                  │                   │                  │
   │                 │                   ├──────────────────────────────────────────────────────────>│                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │ 12. Check cache  │
   │                 │                   │                  │                  │                   ├─────────┐        │
   │                 │                   │                  │                  │                   │         │        │
   │                 │                   │                  │                  │                   │<────────┘        │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │ 13. Fetch from   │
   │                 │                   │                  │                  │                   │     API-Football │
   │                 │                   │                  │                  │                   ├───────────┐      │
   │                 │                   │                  │                  │                   │(External) │      │
   │                 │                   │                  │                  │                   │<──────────┘      │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │ 14. Return stats │
   │                 │                   │<──────────────────────────────────────────────────────────┤                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │ 15. Calculate    │                  │                   │                  │
   │                 │                   │     predictions  │                  │                   │                  │
   │                 │                   ├─────────────────────────────────────────────────────────────────────────────>│
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │ 16. Apply formula
   │                 │                   │                  │                  │                   │                  │     - Form (60%)
   │                 │                   │                  │                  │                   │                  │     - H2H (40%)
   │                 │                   │                  │                  │                   │                  │     - Home bonus
   │                 │                   │                  │                  │                   │                  ├────────────┐
   │                 │                   │                  │                  │                   │                  │            │
   │                 │                   │                  │                  │                   │                  │<───────────┘
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │ 17. Return %s
   │                 │                   │<─────────────────────────────────────────────────────────────────────────────┤
   │                 │                   │                  │                  │                   │                  │
   │                 │                   │ 18. Combine data │                  │                   │                  │
   │                 │                   │     (odds + stats│                  │                   │                  │
   │                 │                   │      + predictions)                 │                   │                  │
   │                 │                   ├─────────┐        │                  │                   │                  │
   │                 │                   │         │        │                  │                   │                  │
   │                 │                   │<────────┘        │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │                 │ 19. Return JSON   │                  │                  │                   │                  │
   │                 │<──────────────────┤                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
   │ 20. Display     │                   │                  │                  │                   │                  │
   │     results     │                   │                  │                  │                   │                  │
   │<────────────────┤                   │                  │                  │                   │                  │
   │                 │                   │                  │                  │                   │                  │
```

## 2. Booking Code Generation Flow

```
┌──────┐        ┌─────────┐        ┌──────────┐        ┌──────────┐        ┌──────────┐        ┌──────────┐
│ User │        │ Next.js │        │   API    │        │ Booking  │        │ Database │        │Bookmaker │
│      │        │  Client │        │  Routes  │        │  Service │        │          │        │   API    │
└──┬───┘        └────┬────┘        └────┬─────┘        └────┬─────┘        └────┬─────┘        └────┬─────┘
   │                 │                   │                   │                   │                   │
   │ 1. Select 3     │                   │                   │                   │                   │
   │    matches      │                   │                   │                   │                   │
   │ 2. Choose H2H   │                   │                   │                   │                   │
   │    outcomes     │                   │                   │                   │                   │
   │ 3. Pick 1xBet   │                   │                   │                   │                   │
   ├────────────────>│                   │                   │                   │                   │
   │                 │                   │                   │                   │                   │
   │                 │ 4. POST /api/     │                   │                   │                   │
   │                 │    booking/       │                   │                   │                   │
   │                 │    generate       │                   │                   │                   │
   │                 ├──────────────────>│                   │                   │                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │ 5. Validate       │                   │                   │
   │                 │                   │    selections     │                   │                   │
   │                 │                   ├─────────┐         │                   │                   │
   │                 │                   │         │         │                   │                   │
   │                 │                   │<────────┘         │                   │                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │ 6. Check if all   │                   │                   │
   │                 │                   │    matches exist  │                   │                   │
   │                 │                   ├──────────────────────────────────────>│                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │ 7. Return matches │                   │
   │                 │                   │<──────────────────────────────────────┤                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │ 8. Calculate      │                   │                   │
   │                 │                   │    total odds     │                   │                   │
   │                 │                   │    (1.65×2.10×1.55│                   │                   │
   │                 │                   │     = 5.37)       │                   │                   │
   │                 │                   ├─────────┐         │                   │                   │
   │                 │                   │         │         │                   │                   │
   │                 │                   │<────────┘         │                   │                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │ 9. Generate code  │                   │                   │
   │                 │                   ├──────────────────>│                   │                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │ 10. Check bookmaker│                   │
   │                 │                   │                   │     capabilities  │                   │
   │                 │                   │                   ├─────────┐         │                   │
   │                 │                   │                   │         │         │                   │
   │                 │                   │                   │<────────┘         │                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │ 11. IF 1xBet has  │                   │
   │                 │                   │                   │     API support   │                   │
   │                 │                   │                   ├──────────────────────────────────────>│
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │                   │ 12. Create betslip│
   │                 │                   │                   │                   │     on bookmaker  │
   │                 │                   │                   │                   │                   ├──────┐
   │                 │                   │                   │                   │                   │      │
   │                 │                   │                   │                   │                   │<─────┘
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │                   │ 13. Return code   │
   │                 │                   │                   │<──────────────────────────────────────┤
   │                 │                   │                   │     (ABC123XYZ)   │                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │ 14. ELSE generate │                   │
   │                 │                   │                   │     internal code │                   │
   │                 │                   │                   │     BET-1XBET-    │                   │
   │                 │                   │                   │     UUID          │                   │
   │                 │                   │                   ├─────────┐         │                   │
   │                 │                   │                   │         │         │                   │
   │                 │                   │                   │<────────┘         │                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │ 15. Store slip    │                   │
   │                 │                   │                   ├──────────────────>│                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │                   │ 16. INSERT INTO   │
   │                 │                   │                   │                   │     betting_slips │
   │                 │                   │                   │                   ├─────────┐         │
   │                 │                   │                   │                   │         │         │
   │                 │                   │                   │                   │<────────┘         │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │ 17. Store selections                  │
   │                 │                   │                   ├──────────────────>│                   │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │                   │ 18. INSERT INTO   │
   │                 │                   │                   │                   │     betting_      │
   │                 │                   │                   │                   │     selections    │
   │                 │                   │                   │                   ├─────────┐         │
   │                 │                   │                   │                   │         │         │
   │                 │                   │                   │                   │<────────┘         │
   │                 │                   │                   │                   │                   │
   │                 │                   │                   │ 19. Return code   │                   │
   │                 │                   │<──────────────────┤                   │                   │
   │                 │                   │                   │                   │                   │
   │                 │ 20. Return JSON   │                   │                   │                   │
   │                 │     with code     │                   │                   │                   │
   │                 │<──────────────────┤                   │                   │                   │
   │                 │                   │                   │                   │                   │
   │ 21. Display code│                   │                   │                   │                   │
   │     + instructions                  │                   │                   │                   │
   │<────────────────┤                   │                   │                   │                   │
   │                 │                   │                   │                   │                   │
   │ 22. Copy code   │                   │                   │                   │                   │
   │     to clipboard│                   │                   │                   │                   │
   ├────────────────>│                   │                   │                   │                   │
   │                 │                   │                   │                   │                   │
```

## 3. WebSocket Real-Time Updates Flow

```
┌──────┐        ┌─────────┐        ┌──────────┐        ┌──────────┐        ┌───────┐        ┌──────────┐
│ User │        │ Next.js │        │ Socket.io│        │Background│        │ Redis │        │   Odds   │
│      │        │  Client │        │  Server  │        │   Job    │        │ Pub/Sub        │ Service  │
└──┬───┘        └────┬────┘        └────┬─────┘        └────┬─────┘        └───┬───┘        └────┬─────┘
   │                 │                   │                   │                  │                  │
   │ 1. Open app     │                   │                   │                  │                  │
   │    (Dashboard)  │                   │                   │                  │                  │
   ├────────────────>│                   │                   │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │ 2. Connect to     │                   │                  │                  │
   │                 │    WebSocket      │                   │                  │                  │
   │                 ├──────────────────>│                   │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │ 3. Handshake      │                  │                  │
   │                 │                   ├─────────┐         │                  │                  │
   │                 │                   │         │         │                  │                  │
   │                 │                   │<────────┘         │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │ 4. Connection OK  │                   │                  │                  │
   │                 │<──────────────────┤                   │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │ 5. Join room      │                   │                  │                  │
   │                 │    "epl-2025-11-30"                   │                  │                  │
   │                 ├──────────────────>│                   │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │ 6. Add to room    │                  │                  │
   │                 │                   ├─────────┐         │                  │                  │
   │                 │                   │         │         │                  │                  │
   │                 │                   │<────────┘         │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │ ┌────────────────┐                  │
   │                 │                   │                   │ │Every 5 minutes │                  │
   │                 │                   │                   │ └────────────────┘                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │ 7. Fetch fresh   │                  │
   │                 │                   │                   │    odds          │                  │
   │                 │                   │                   ├─────────────────────────────────────>│
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │                  │                  │ 8. Call APIs
   │                 │                   │                   │                  │                  ├───────────┐
   │                 │                   │                   │                  │                  │           │
   │                 │                   │                   │                  │                  │<──────────┘
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │                  │ 9. Return odds   │
   │                 │                   │                   │<─────────────────────────────────────┤
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │ 10. Compare with │                  │
   │                 │                   │                   │     cached odds  │                  │
   │                 │                   │                   ├──────────────────>│                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │                  │ 11. Find changes │
   │                 │                   │                   │<──────────────────┤                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │ 12. Publish event│                  │
   │                 │                   │                   │     to Redis     │                  │
   │                 │                   │                   ├──────────────────>│                  │
   │                 │                   │                   │                  │                  │
   │                 │                   │                   │                  │ 13. Notify       │
   │                 │                   │<──────────────────────────────────────┤     subscribers│
   │                 │                   │                   │                  │                  │
   │                 │                   │ 14. Emit to room  │                  │                  │
   │                 │                   │     "odds:updated"│                  │                  │
   │                 │                   ├─────────┐         │                  │                  │
   │                 │                   │         │         │                  │                  │
   │                 │                   │<────────┘         │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │ 15. Receive event │                   │                  │                  │
   │                 │<──────────────────┤                   │                  │                  │
   │                 │                   │                   │                  │                  │
   │                 │ 16. Update UI     │                   │                  │                  │
   │                 │     - Highlight   │                   │                  │                  │
   │                 │       changes     │                   │                  │                  │
   │                 │     - Show toast  │                   │                  │                  │
   │                 ├─────────┐         │                   │                  │                  │
   │                 │         │         │                   │                  │                  │
   │                 │<────────┘         │                   │                  │                  │
   │                 │                   │                   │                  │                  │
   │ 17. See updated │                   │                   │                  │                  │
   │     odds        │                   │                   │                  │                  │
   │<────────────────┤                   │                   │                  │                  │
   │                 │                   │                   │                  │                  │
```

## 4. User Preference Adjustment Flow

```
┌──────┐        ┌─────────┐        ┌──────────┐        ┌──────────┐        ┌──────────┐
│ User │        │ Next.js │        │   API    │        │ Database │        │Prediction│
│      │        │  Client │        │  Routes  │        │          │        │  Engine  │
└──┬───┘        └────┬────┘        └────┬─────┘        └────┬─────┘        └────┬─────┘
   │                 │                   │                   │                   │
   │ 1. Adjust       │                   │                   │                   │
   │    weights:     │                   │                   │                   │
   │    Form: 70%    │                   │                   │                   │
   │    H2H: 30%     │                   │                   │                   │
   ├────────────────>│                   │                   │                   │
   │                 │                   │                   │                   │
   │                 │ 2. PUT /api/user/ │                   │                   │
   │                 │    preferences    │                   │                   │
   │                 ├──────────────────>│                   │                   │
   │                 │                   │                   │                   │
   │                 │                   │ 3. Update DB      │                   │
   │                 │                   ├──────────────────>│                   │
   │                 │                   │                   │                   │
   │                 │                   │                   │ 4. Save weights   │
   │                 │                   │<──────────────────┤                   │
   │                 │                   │                   │                   │
   │                 │                   │ 5. Recalculate    │                   │
   │                 │                   │    predictions    │                   │
   │                 │                   ├──────────────────────────────────────>│
   │                 │                   │                   │                   │
   │                 │                   │                   │                   │ 6. Apply new
   │                 │                   │                   │                   │    weights
   │                 │                   │                   │                   ├────────────┐
   │                 │                   │                   │                   │            │
   │                 │                   │                   │                   │<───────────┘
   │                 │                   │                   │                   │
   │                 │                   │                   │ 7. New percentages│
   │                 │                   │<──────────────────────────────────────┤
   │                 │                   │                   │                   │
   │                 │ 8. Return updated │                   │                   │
   │                 │    predictions    │                   │                   │
   │                 │<──────────────────┤                   │                   │
   │                 │                   │                   │                   │
   │ 9. Display new  │                   │                   │                   │
   │    win %s       │                   │                   │                   │
   │<────────────────┤                   │                   │                   │
   │                 │                   │                   │                   │
```

## 5. Error Recovery Flow

```
┌──────────┐        ┌──────────┐        ┌──────────┐        ┌──────────┐
│   Odds   │        │  Fallback│        │   Cache  │        │   User   │
│ Service  │        │  Handler │        │          │        │          │
└────┬─────┘        └────┬─────┘        └────┬─────┘        └────┬─────┘
     │                   │                   │                   │
     │ 1. Fetch odds     │                   │                   │
     │    from The Odds  │                   │                   │
     │    API            │                   │                   │
     ├────────┐          │                   │                   │
     │        │          │                   │                   │
     │<───────┘          │                   │                   │
     │                   │                   │                   │
     │ 2. ❌ 429 Rate    │                   │                   │
     │    Limit Error    │                   │                   │
     ├──────────────────>│                   │                   │
     │                   │                   │                   │
     │                   │ 3. Try RapidAPI   │                   │
     │                   ├────────┐          │                   │
     │                   │        │          │                   │
     │                   │<───────┘          │                   │
     │                   │                   │                   │
     │                   │ 4. ❌ Also fails  │                   │
     │                   ├──────────────────>│                   │
     │                   │                   │                   │
     │                   │                   │ 5. Return cached  │
     │                   │                   │    data           │
     │                   │<──────────────────┤    (if exists)    │
     │                   │                   │                   │
     │                   │ 6. Return with    │                   │
     │                   │    warning flag   │                   │
     │                   ├──────────────────────────────────────>│
     │                   │                   │                   │
     │                   │                   │ 7. Display warning│
     │                   │                   │    "Using cached  │
     │                   │                   │     data (5 min   │
     │                   │                   │     old)"         │
     │                   │                   │                   ├──────┐
     │                   │                   │                   │      │
     │                   │                   │                   │<─────┘
     │                   │                   │                   │
```

## 6. Activity Diagram: Complete User Journey

```
                    START
                      │
                      ▼
            ┌──────────────────┐
            │  User lands on   │
            │    Dashboard     │
            └─────────┬────────┘
                      │
                      ▼
            ┌──────────────────┐
            │ Set preferences: │
            │ - Odds range     │
            │ - Markets        │
            │ - Bookmakers     │
            │ - Date range     │
            └─────────┬────────┘
                      │
                      ▼
            ┌──────────────────┐
            │ Click "Search    │
            │     Matches"     │
            └─────────┬────────┘
                      │
                      ▼
         ╔════════════════════════╗
         ║  System fetches odds   ║
         ║  from aggregator       ║
         ╚════════════┬═══════════╝
                      │
                      ▼
         ╔════════════════════════╗
         ║  System enriches with  ║
         ║  team stats & H2H      ║
         ╚════════════┬═══════════╝
                      │
                      ▼
         ╔════════════════════════╗
         ║  Prediction engine     ║
         ║  calculates win %s     ║
         ╚════════════┬═══════════╝
                      │
                      ▼
            ┌──────────────────┐
            │ Display results  │
            │ grid with:       │
            │ - Odds           │
            │ - Predictions    │
            │ - Confidence     │
            └─────────┬────────┘
                      │
               ┌──────┴──────┐
               │             │
               ▼             ▼
      ┌────────────┐  ┌────────────┐
      │  Adjust    │  │  Select    │
      │  weights?  │  │  matches?  │
      └──────┬─────┘  └──────┬─────┘
             │               │
             │ Yes           │ Yes
             │               ▼
             │      ┌────────────────┐
             │      │ Choose outcomes│
             │      │ for each match │
             │      └───────┬────────┘
             │              │
             │              ▼
             │      ┌────────────────┐
             │      │ Select primary │
             │      │   bookmaker    │
             │      └───────┬────────┘
             │              │
             │              ▼
             │      ┌────────────────┐
             │      │ Click "Generate│
             │      │  Booking Code" │
             │      └───────┬────────┘
             │              │
             │              ▼
             │   ╔═══════════════════╗
             │   ║ System generates  ║
             │   ║    code & stores  ║
             │   ╚═══════╤═══════════╝
             │           │
             │           ▼
             │   ┌────────────────┐
             │   │ Display code + │
             │   │  instructions  │
             │   └───────┬────────┘
             │           │
             │           ▼
             │   ┌────────────────┐
             │   │ User copies    │
             │   │ code to        │
             │   │ bookmaker site │
             │   └───────┬────────┘
             │           │
             └───────────┴────────┐
                                  │
                                  ▼
                          ┌────────────┐
                          │    END     │
                          └────────────┘
```
